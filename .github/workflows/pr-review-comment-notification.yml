name: ÎîîÏä§ÏΩîÎìú PR Î¶¨Î∑∞ ÏïåÎ¶º with ÏΩîÎìú Ïª®ÌÖçÏä§Ìä∏
on:
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.comment.user.type != 'Bot'
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_PR_REVIEW_WEBHOOK_URL }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          DIFF_HUNK: ${{ github.event.comment.diff_hunk }}
          FILE_PATH: ${{ github.event.comment.path }}
        run: |
          # Discord front-end Ïó≠Ìï† ID
          DISCORD_ROLE_ID="1351886402911998012"
          
          # ÏΩîÎ©òÌä∏ ÎÇ¥Ïö© Ï≤òÎ¶¨ (500Ïûê Ï†úÌïú)
          COMMENT_PREVIEW=$(echo "$COMMENT_BODY" | head -c 500)
          if [ ${#COMMENT_BODY} -gt 500 ]; then
            COMMENT_PREVIEW="${COMMENT_PREVIEW}..."
          fi
          
          # Diff context Í∞ÑÎûµÌûà ÌëúÏãú (ÎßàÏßÄÎßâ 5Ï§ÑÎßå)
          DIFF_PREVIEW=$(echo "$DIFF_HUNK" | tail -n 5)
          
          # JSON payload ÏÉùÏÑ± Use jq for safety
          jq -n \
            --arg role_id "$DISCORD_ROLE_ID" \
            --arg title "$PR_TITLE" \
            --arg pr_url "$PR_URL" \
            --arg pr_author "$PR_AUTHOR" \
            --arg file_path "$FILE_PATH" \
            --arg comment_author "$COMMENT_AUTHOR" \
            --arg comment_url "$COMMENT_URL" \
            --arg comment_body "$COMMENT_PREVIEW" \
            --arg diff_hunk "$DIFF_PREVIEW" \
            '{
              content: ("<@&" + $role_id + "> **" + $pr_author + "**ÎãòÏóêÍ≤å ÏΩîÎìú Î¶¨Î∑∞ ÏΩîÎ©òÌä∏Í∞Ä Îã¨Î†∏ÏäµÎãàÎã§!"),
              embeds: [{
                title: $title,
                url: $pr_url,
                color: 16753920,
                fields: [
                  {name: "üìÅ ÌååÏùº", value: ("`" + $file_path + "`"), inline: false},
                  {name: "üí¨ ÏΩîÎ©òÌä∏ ÏûëÏÑ±Ïûê", value: $comment_author, inline: true},
                  {name: "üîó ÎßÅÌÅ¨", value: ("[Î∞îÎ°úÍ∞ÄÍ∏∞](" + $comment_url + ")"), inline: true},
                  {name: "üìù ÏΩîÎ©òÌä∏ ÎÇ¥Ïö©", value: $comment_body, inline: false},
                  {name: "üìÑ ÏΩîÎìú Ïª®ÌÖçÏä§Ìä∏", value: ("```diff\n" + $diff_hunk + "\n```"), inline: false}
                ]
              }]
            }' > payload.json
          
          # Discord webhook Ï†ÑÏÜ°
          curl -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK_URL"
