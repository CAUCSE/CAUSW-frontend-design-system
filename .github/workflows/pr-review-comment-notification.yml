name: Discord PR Code Review Comment Notification
on:
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.PR_BOT_WEBHOOK_URL }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          DIFF_HUNK: ${{ github.event.comment.diff_hunk }}
          FILE_PATH: ${{ github.event.comment.path }}
        run: |
          # Discord front-end ì—­í•  ID
          DISCORD_ROLE_ID="1351886402911998012"
          
          # ì½”ë©˜íŠ¸ ë‚´ìš© ì²˜ë¦¬ (500ì ì œí•œ)
          COMMENT_PREVIEW=$(echo "$COMMENT_BODY" | head -c 500)
          if [ ${#COMMENT_BODY} -gt 500 ]; then
            COMMENT_PREVIEW="${COMMENT_PREVIEW}..."
          fi
          
          # Diff context ê°„ëµíˆ í‘œì‹œ (ë§ˆì§€ë§‰ 3ì¤„ë§Œ)
          DIFF_PREVIEW=$(echo "$DIFF_HUNK" | tail -n 3)
          
          # JSON escape
          COMMENT_PREVIEW=$(echo "$COMMENT_PREVIEW" | jq -Rs .)
          DIFF_PREVIEW=$(echo "$DIFF_PREVIEW" | jq -Rs .)
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | jq -Rs .)
          
          # Discord webhook ì „ì†¡
          curl -X POST -H "Content-Type: application/json" -d '{
            "content": "<@&'"$DISCORD_ROLE_ID"'> ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!",
            "embeds": [
              {
                "title": '"$PR_TITLE_ESCAPED"',
                "url": "'"$PR_URL"'",
                "color": 16753920,
                "fields": [
                  {
                    "name": "ğŸ“ íŒŒì¼",
                    "value": "`'"$FILE_PATH"'`",
                    "inline": false
                  },
                  {
                    "name": "ğŸ’¬ ì½”ë©˜íŠ¸ ì‘ì„±ì",
                    "value": "'"$COMMENT_AUTHOR"'",
                    "inline": true
                  },
                  {
                    "name": "ğŸ”— ë§í¬",
                    "value": "[ë°”ë¡œê°€ê¸°]('"$COMMENT_URL"')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“ ì½”ë©˜íŠ¸ ë‚´ìš©",
                    "value": '"$COMMENT_PREVIEW"',
                    "inline": false
                  },
                  {
                    "name": "ğŸ“„ ì½”ë“œ ì»¨í…ìŠ¤íŠ¸",
                    "value": "```\n'"$DIFF_PREVIEW"'\n```",
                    "inline": false
                  }
                ]
              }
            ]
          }' $DISCORD_WEBHOOK_URL
