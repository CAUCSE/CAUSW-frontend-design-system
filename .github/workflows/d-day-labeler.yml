name: D-n ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÏºÄÏ§ÑÎü¨

on:
  schedule:
    - cron: '0 0 * * *' # UTC 00:00 = KST 09:00

permissions:
  contents: read
  pull-requests: write

jobs:
  d-day-labeler:
    runs-on: ubuntu-latest

    steps:
      # Step A: ÏóÖÎç∞Ïù¥Ìä∏ Ï†Ñ ÏÉÅÌÉú Ïä§ÎÉÖÏÉ∑
      - name: Snapshot BEFORE d-day update
        id: before
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              base: "dev"
            });

            const before = {};
            for (const pr of pulls.data) {
              const d = pr.labels.find(l => /^D-\d+$/.test(l.name));
              if (d) before[pr.number] = d.name;
            }

            return before;

      # Step B: D-n ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
      - name: Update D-n Labels
        uses: naver/d-day-labeler@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step C: ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ ÏÉÅÌÉú + diff ÌåêÎã®
      - name: Detect D-2‚ÜíD-1 / D-1‚ÜíD-0
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const before = JSON.parse(`${{ steps.before.outputs.result }}`);

            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              base: "dev"
            });

            const notify = [];

            for (const pr of pulls.data) {
              const afterLabel = pr.labels.find(l => /^D-\d+$/.test(l.name));
              if (!afterLabel) continue;

              const after = afterLabel.name;
              const prev = before[pr.number];

              if (
                (prev === "D-2" && after === "D-1") ||
                (prev === "D-1" && after === "D-0")
              ) {
                notify.push({
                  number: pr.number,
                  title: pr.title,
                  url: pr.html_url,
                  prefix: after === "D-0" ? "üö® [D-0]" : "‚è≥ [D-1]"
                });
              }
            }

            return notify;

      # Discord ÏïåÎ¶º
      - name: Send Discord notification
        if: ${{ steps.detect.outputs.result != '[]' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_PR_REMINDER_WEBHOOK_URL }}
        run: |
          content=$(echo '${{ steps.detect.outputs.result }}' | jq -r '
            .[] |
            (.prefix + " PR #" + (.number|tostring) + ": " + .title) + "\n" + .url + "\n"
          ')

          jq -n \
            --arg title "‚è∞ ÎßàÍ∞ê ÏûÑÎ∞ï PR ÏïåÎ¶º" \
            --arg body "$content" \
            '{content: ($title + "\n\n" + $body)}' \
          | curl -X POST \
              -H "Content-Type: application/json" \
              -d @- \
              "$DISCORD_WEBHOOK_URL"