name: 디스코드 PR 생성 알림
on:
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_PR_REMINDER_WEBHOOK_URL }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if [[ "$IS_DRAFT" == "true" || "$PR_BRANCH" == "develop" || "$PR_BRANCH" == "main" || "$PR_BRANCH" == chore* || "$PR_BRANCH" == hotfix*  ]]; then
            if [[ "$IS_DRAFT" == "true" ]]; then
              echo "Draft PR입니다. 디스코드 알림을 보내지 않습니다."
            else
              echo "리뷰어를 자동으로 추가하지 않는 브랜치입니다."
            fi
          else  
            # Discord front-end 역할 ID
            DISCORD_ROLE_ID="1351886402911998012"
            
            # JSON payload 생성 Use jq for safety
            jq -n \
              --arg role_id "$DISCORD_ROLE_ID" \
              --arg title "$PR_TITLE" \
              --arg pr_url "$PR_URL" \
              --arg pr_author "$PR_AUTHOR" \
              --arg pr_body "$PR_BODY" \
              '{
                content: ("<@&" + $role_id + "> **" + $pr_author + "**님의 새로운 PR이 생성되었습니다! 리뷰 부탁드립니다."),
                embeds: [{
                  title: $title,
                  url: $pr_url,
                  description: ("작성자: **" + $pr_author + "**\n\n" + ($pr_body | .[0:500]) + (if ($pr_body | length) > 500 then "..." else "" end))
                }]
              }' > payload.json

            # Discord webhook 전송
            curl -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK_URL"
          fi
