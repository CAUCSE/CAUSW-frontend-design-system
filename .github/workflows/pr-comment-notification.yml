name: Discord PR Comment Notification
on:
  issue_comment:
    types: [created]

jobs:
  notify:
    # PR에 달린 코멘트만 처리
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.PR_BOT_WEBHOOK_URL }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          PR_TITLE: ${{ github.event.issue.title }}
          PR_URL: ${{ github.event.issue.html_url }}
        run: |
          # Discord front-end 역할 ID
          DISCORD_ROLE_ID="1351886402911998012"
          
          # 코멘트 내용 줄바꿈 처리 및 길이 제한 (200자)
          COMMENT_PREVIEW=$(echo "$COMMENT_BODY" | head -c 200)
          if [ ${#COMMENT_BODY} -gt 200 ]; then
            COMMENT_PREVIEW="${COMMENT_PREVIEW}..."
          fi
          
          # JSON escape 처리
          COMMENT_PREVIEW=$(echo "$COMMENT_PREVIEW" | jq -Rs .)
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | jq -Rs .)
          
          # Discord webhook 전송
          curl -X POST -H "Content-Type: application/json" -d '{
            "content": "<@&'"$DISCORD_ROLE_ID"'> 새로운 코멘트가 달렸습니다!",
            "embeds": [
              {
                "title": '"$PR_TITLE_ESCAPED"',
                "url": "'"$PR_URL"'",
                "description": "**작성자**: '"$COMMENT_AUTHOR"'\n\n**코멘트**:\n'"$COMMENT_PREVIEW"'",
                "color": 5814783,
                "fields": [
                  {
                    "name": "링크",
                    "value": "[코멘트 바로가기]('"$COMMENT_URL"')"
                  }
                ]
              }
            ]
          }' $DISCORD_WEBHOOK_URL
