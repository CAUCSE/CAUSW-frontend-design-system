name: ë””ìŠ¤ì½”ë“œ PR ë¦¬ë·° ì•Œë¦¼
on:
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.review.user.type != 'Bot'
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_PR_REVIEW_WEBHOOK_URL }}
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          REVIEW_URL: ${{ github.event.review.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Discord front-end ì—­í•  ID
          DISCORD_ROLE_ID="1351886402911998012"
          
          # ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ë° ìƒ‰ìƒ ì„¤ì •
          case "$REVIEW_STATE" in
            "approved")
              REVIEW_TYPE="âœ… ìŠ¹ì¸"
              EMBED_COLOR=3066993
              MESSAGE="<@&${DISCORD_ROLE_ID}> **${PR_AUTHOR}**ë‹˜ì˜ PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
              ;;
            "changes_requested")
              REVIEW_TYPE="ğŸ”„ ë³€ê²½ ìš”ì²­"
              EMBED_COLOR=15158332
              MESSAGE="<@&${DISCORD_ROLE_ID}> **${PR_AUTHOR}**ë‹˜ì—ê²Œ ë³€ê²½ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤!"
              ;;
            "commented")
              REVIEW_TYPE="ğŸ’¬ ë¦¬ë·° ì½”ë©˜íŠ¸"
              EMBED_COLOR=5814783
              MESSAGE="<@&${DISCORD_ROLE_ID}> **${PR_AUTHOR}**ë‹˜ì—ê²Œ ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!"
              ;;
            *)
              REVIEW_TYPE="ğŸ“ ë¦¬ë·°"
              EMBED_COLOR=10181046
              MESSAGE="<@&${DISCORD_ROLE_ID}> **${PR_AUTHOR}**ë‹˜ì—ê²Œ ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!"
              ;;
          esac
          
          # ë¦¬ë·° ë‚´ìš© ì²˜ë¦¬ (ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŒ)
          if [ -n "$REVIEW_BODY" ]; then
            REVIEW_PREVIEW=$(echo "$REVIEW_BODY" | head -c 500)
            if [ ${#REVIEW_BODY} -gt 500 ]; then
              REVIEW_PREVIEW="${REVIEW_PREVIEW}..."
            fi
            REVIEW_PREVIEW=$(echo "$REVIEW_PREVIEW" | jq -Rs .)
            DESCRIPTION="**ë¦¬ë·°ì–´**: ${REVIEW_AUTHOR}\n**ìƒíƒœ**: ${REVIEW_TYPE}\n\n> ${REVIEW_PREVIEW}"
          else
            DESCRIPTION="**ë¦¬ë·°ì–´**: ${REVIEW_AUTHOR}\n**ìƒíƒœ**: ${REVIEW_TYPE}\n\n_ì½”ë©˜íŠ¸ ì—†ìŒ_"
          fi
          
          # JSON escape
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | jq -Rs .)
          DESCRIPTION_ESCAPED=$(echo "$DESCRIPTION" | jq -Rs .)
          
          # Discord webhook ì „ì†¡
          curl -X POST -H "Content-Type: application/json" -d '{
            "content": "'"$MESSAGE"'",
            "embeds": [
              {
                "title": '"$PR_TITLE_ESCAPED"',
                "url": "'"$PR_URL"'",
                "description": '"$DESCRIPTION_ESCAPED"',
                "color": '"$EMBED_COLOR"',
                "fields": [
                  {
                    "name": "PR ì‘ì„±ì",
                    "value": "'"$PR_AUTHOR"'",
                    "inline": true
                  },
                  {
                    "name": "ë§í¬",
                    "value": "[ë¦¬ë·° ë°”ë¡œê°€ê¸°]('"$REVIEW_URL"')",
                    "inline": true
                  }
                ]
              }
            ]
          }' $DISCORD_WEBHOOK_URL
